<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¾®ä¿¡æ”¯ä»˜æ¨¡æ‹Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #qrcode { margin: 20px 0; }
        #status { font-weight: bold; }
    </style>
</head>
<body>

<h1>å¾®ä¿¡æ”¯ä»˜æ¨¡æ‹Ÿæµ‹è¯•</h1>

<label>
    è®¢å•å·ï¼š<input type="text" id="orderId" value="ORDER123456" />
</label>
<br /><br />
<label>
    é‡‘é¢(å…ƒ)ï¼š<input type="number" id="amount" value="0.01" step="0.01" />
</label>
<br /><br />
<button id="btnCreate">åˆ›å»ºæ”¯ä»˜è®¢å•</button>

<div id="qrcode"></div>
<div id="status"></div>

<!-- æ¨¡æ‹Ÿæ‰«ç æ”¯ä»˜å›è°ƒæŒ‰é’® -->
<button id="btnCallback" style="display:none;">ğŸ“¡ æ¨¡æ‹Ÿæ‰«ç æ”¯ä»˜æˆåŠŸï¼ˆå‘é€å›è°ƒï¼‰</button>

<pre id="callbackResult"></pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    let pollTimer = null;
    let gPrepayId = null;

    function md5(str) {
        return CryptoJS.MD5(str).toString().toUpperCase();
    }

    function generateSign(params, apiKey) {
        const keys = Object.keys(params).filter(k => k !== 'sign' && params[k]).sort();
        const str = keys.map(k => `${k}=${params[k]}`).join('&') + `&key=${apiKey}`;
        return md5(str);
    }

    document.getElementById('btnCreate').addEventListener('click', () => {
        const orderId = document.getElementById('orderId').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);

        if (!orderId) {
            alert('è¯·è¾“å…¥è®¢å•å·');
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            alert('è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢');
            return;
        }

        fetch('http://localhost:8081/api/pay/unifiedorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId, amount: amount }),
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 0) {
                    const codeUrl = data.data.code_url;
                    const prepayId = data.data.prepay_id;
                    gPrepayId = prepayId;

                    document.getElementById('qrcode').innerHTML = `
                        <p>äºŒç»´ç é“¾æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰:</p>
                        <a href="${codeUrl}" target="_blank">${codeUrl}</a>
                        <p>é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†: ${prepayId}</p>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(codeUrl)}" alt="äºŒç»´ç " />
                    `;
                    document.getElementById('status').innerText = 'ç­‰å¾…æ”¯ä»˜...';
                    document.getElementById('btnCallback').style.display = 'inline';

                    if (pollTimer) clearInterval(pollTimer);
                    pollTimer = setInterval(() => {
                        fetch(`http://localhost:8081/api/pay/order_status?order_id=${orderId}`)
                            .then(res => res.json())
                            .then(statusData => {
                                if (statusData.code === 0 && statusData.data.status === 1) {
                                    document.getElementById('status').innerHTML = '<span style="color:#209520;">âœ… æ”¯ä»˜æˆåŠŸï¼</span>';
                                    clearInterval(pollTimer);
                                }
                            });
                    }, 3000);

                } else {
                    alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + data.msg);
                }
            })
            .catch(err => alert('è¯·æ±‚å¤±è´¥: ' + err));
    });

    document.getElementById('btnCallback').addEventListener('click', () => {
        const orderId = document.getElementById('orderId').value.trim();
        fetch(`http://localhost:8081/api/pay/callback?order_id=${orderId}`)
            .then(res => res.text())
            .then(text => {
                document.getElementById("callbackResult").innerText = "æ¨¡æ‹Ÿå›è°ƒå“åº”ï¼š\n" + text;
            })
            .catch(err => {
                document.getElementById("callbackResult").innerText = "è¯·æ±‚å¤±è´¥: " + err;
            });
    });
</script>

</body>
</html>
